<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">	
	<title>Cria Chamada</title>
	<script>
        function obterLocalizacao() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async function(position) {
                    var latitude = position.coords.latitude;
                    var longitude = position.coords.longitude;
					
                    // Enviar localização para o servidor
                    // enviarLocalizacao(latitude, longitude);
					document.getElementById("geoloc").value = `${latitude},${longitude}`
					document.getElementById("endereco").innerHTML = await descobrirEndereco(latitude,longitude)
                });
            } else {
                alert("Geolocalização não é suportada neste navegador.");
            }
        }

		async function descobrirEndereco(latitude, longitude){
			var url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&sensor=true&key=AIzaSyBVm-76I3Vi78atDYs-J2w4sKeK-KSBxP0`
			let data;			
			
			var resultado =  await fetch(url)
			var resultado_json = await resultado.json()
			
			return resultado_json["results"][0]["formatted_address"]			
		}

        function enviarLocalizacao(latitude, longitude) {
            let x = Math.random() * 1000;
            var num_str = Math.floor(x).toString()
            fetch("http://localhost:5000/SalvarLocalizacao", {
                method: "POST",
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    id: num_str
                }),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            });

            // var xhr = new XMLHttpRequest();
            // xhr.open("POST", "SalvarLocalizacao", true);
            // xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            // xhr.send("latitude=" + latitude + "&longitude=" + longitude);
        }
    </script>
</head>
<body>
	<h1>Criando chamada na turma: {{desc_turma}}</h1>
	<br>
	<button onclick="obterLocalizacao()">Pegar geoloc</button>	
	<div id="endereco"></div>
	<br>
	<form action="/cria_chamada" method="post">
		<section id="cria_chamada">
			<input type="hidden" name="geoloc" id="geoloc" value="">
			<input type="hidden" name="idTurma" value={{idTurma}}>
			<label for="data_ini">Data de início da chamada</label>
			<input type="date" name="data_ini" id="data_ini" required>
			<br>
			<label for="hora_ini">Hora de início da chamada</label>
			<input type="time" name="hora_ini" id="hora_ini" required>
			<br>
			<label for="data_fim">Data de fim da chamada</label>
			<input type="date" name="data_fim" id="data_fim" required>
			<br>
			<label for="hora_fim">Hora de fim da chamada</label>
			<input type="time" name="hora_fim" id="hora_fim" required>			
			<br>
			<button type ="submit" value="cadastrar" id="btn-cadastrar">CADASTRAR</button>
			<br><br><br>
					
		</section>
	</form>	
</body>
</html>